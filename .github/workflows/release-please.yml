name: release-please

on:
  push:
    branches: [master]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: release-please
  cancel-in-progress: false

jobs:
  release-please:
    runs-on: ubuntu-latest

    steps:
      - name: Release Please
        id: rp
        uses: googleapis/release-please-action@v4
        with:
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

      # If a release was just created, publish to npm from the same workflow run.
      # This avoids GitHub's limitation where events created by GITHUB_TOKEN (e.g. release creation)
      # don't trigger additional workflows.
      - name: Checkout
        if: steps.rp.outputs.release_created == 'true'
        uses: actions/checkout@v4

      - name: Setup Node
        if: steps.rp.outputs.release_created == 'true'
        uses: actions/setup-node@v6
        with:
          node-version: 20.20.0
          registry-url: "https://registry.npmjs.org"
          cache: npm

      - name: Install system deps
        if: steps.rp.outputs.release_created == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y gettext

      - name: Install deps
        if: steps.rp.outputs.release_created == 'true'
        run: npm ci

      - name: Test
        if: steps.rp.outputs.release_created == 'true'
        run: npm test

      - name: Build
        if: steps.rp.outputs.release_created == 'true'
        run: npm run build

      - name: Publish
        if: steps.rp.outputs.release_created == 'true'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail

          TAG_NAME="${{ steps.rp.outputs.tag_name }}"

          # Extract semver version from a tag like:
          #   vue3-gettext-v4.1.1
          #   vue3-gettext-v4.1.1-beta.1
          # We intentionally key off the "-v" delimiter so prerelease identifiers like "dev.1"
          # (which contain the letter v) don't break parsing.
          if [[ "$TAG_NAME" =~ -v([0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?)$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
          else
            echo "Could not parse version from tag: $TAG_NAME" >&2
            exit 1
          fi

          # If VERSION contains a prerelease suffix (hyphen), publish to `next`.
          if [[ "$VERSION" == *-* ]]; then
            echo "Publishing prerelease $VERSION to dist-tag: next"
            npm publish --tag next
          else
            echo "Publishing release $VERSION to dist-tag: latest"
            npm publish
          fi
